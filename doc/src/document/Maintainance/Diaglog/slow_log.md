SequoiaCM 支持监控网关服务、内容服务、S3 服务的请求处理耗时，以及该请求涉及的各项内部操作耗时，当请求处理时间或内部操作的执行时间达到用户设置的阈值时，会在日志文件中打印慢操作告警信息。

## 存储配置 ##

内容服务节点安装目录下的 conf 目录，包含节点的日志配置文件 logback.xml，其中 slowlogTOFILE 为慢操作日志记录至文件的 appender。可以通过修改这个 appender
的属性改变日志输出配置，默认情况下慢操作日志会输出到 slowlog.log 这个文件中。

## 慢操作配置 ##

慢操作日志通过节点的配置文件（application.properties）进行配置：

|配置项  |类型        |说明                           | 生效类型 |
|--------------|----------------|-------------------------------|----|
|scm.slowlog.enabled         |boolean    |是否开启慢操作告警功能，默认值：false       |在线生效|
|scm.slowlog.allRequest      |num        |配置全局所有请求的告警阈值，当某个请求的处理时间大于或等于此值时，会在日志文件中打印慢操作告警信息。 默认值：-1（负数表示无限大的告警阈值），单位：毫秒      |在线生效|
|scm.slowlog.request.xxx     |num        |单独配置某类请求的告警阈值，xxx 填写请求方式和地址，如：scm.slowlog.request.[POST/api/v1/files]=10000 配置文件上传请求的告警阈值为 10 秒，由于请求地址中包含特殊字符，需要用 [ ] 包裹。下方的表格中列举了常见的请求及其请求路径 |在线生效|
|scm.slowlog.allOperation    |num        |配置全局内部操作的告警阈值，当某个内部操作的执行时间大于或等于此值时，会在日志文件中打印慢操作告警信息。 默认值：-1（负数表示无限大的告警阈值），单位：毫秒    |在线生效|
|scm.slowlog.operation.xxx   |num        |单独配置某个内部操作的告警阈值，xxx 填写具体的操作名称，当前具体支持的操作请见下方的内部操作说明列表   |在线生效|
|scm.slowlog.appender        |str        |配置慢操作信息输出的位置：LOGGER：输出到日志文件、TRACER：输出到链路追踪系统的链路信息中，可同时配置多个（用逗号隔开），默认值：LOGGER,TRACER                                                    |在线生效|

**常见请求及其请求路径说明列表**

|请求名称         |所属服务               |请求路径                        |
|---------------|----------------------|-----------------------|
|上传文件        |内容服务               |[POST/api/v1/files]            |
|下载文件        |内容服务               |[GET/api/v1/files/*]           |
|列取文件        |内容服务               |[GET/api/v1/files]             |
|更新文件        |内容服务               |[PUT/api/v1/files/*]           |
|获取某个文件     |内容服务               |[HEAD/api/v1/files/*/**]       |
|上传对象        |S3 服务               |[PUT/{bucketname}/**]          |
|下载对象        |S3 服务               |[GET/{bucketname}/**]          |

**Note**
>
> - 以上配置支持动态修改在线生效，参考[配置方式章节][config_means]
> 
> - 支持使用通配符，* 表示匹配0个或多个字符，** 表示匹配多级目录
> 
> - 请用具体的桶名替代 S3 服务请求路径中的{bucketname}

**内部操作说明列表**

|内部操作类型     |触发场景               |说明                            |
|---------------|---------------------|-------------------------------|
|openWriter     |数据源写入操作，如文件上传      |创建数据存储对象（如创建 lob）  |
|writeData      |数据源写入操作，如文件上传      |写数据到存储对象               |
|closeWriter    |数据源写入操作，如文件上传      |关闭数据存储对象（如关闭 lob）  |
|calcMD5        |数据源写入操作，如文件上传      |计算文件内容的 MD5            |
|preCreate      |文件上传                    |文件上传前置处理               |
|postCreate     |文件上传                    |文件上传后置处理              |
|accessMeta     |读、写元数据服务             |访问元数据服务                 |
|openReader     |数据源读取操作，如文件下载     |打开数据存储对象（如打开 lob）   |
|readData       |数据源读取操作，如文件下载     |读取数据存储对象中的内容         |
|seekData       |数据源读取操作，如文件下载     |偏移读取数据存储对象中的内容     |
|closeReader    |数据源读取操作，如文件下载     |关闭数据存储对象（如关闭 lob）  |
|acquireLock    |获取分布式锁                |获取分布式锁                 |
|releaseLock    |释放分布式锁                |释放分布式锁                 |
|feign          |远程调用                   |远程调用                    |

## 慢操作告警信息 ##

具体告警日志包含的信息如下：

|审计信息               |说明                       |示例                                             |
|----------------------|--------------------------|-------------------------------------------------|
|sessionId             |发起请求用户的 sessionId     |d73d3bf9-ea22-4f19-b620-0a567dca5661                                       |
|spend                 |本次请求总的处理时间          |135ms                                       |
|method                |请求方式                    |POST                                 |
|path                  |请求路径                    |/api/v1/files/?workspace_name=ws_default                               |
|start                 |请求开始时间                 |2022-04-26 11:19:47.108                                     |
|end                   |请求结束时间                 |2022-04-26 11:19:47.243                                     |
|readClientSpend       |读取客户端请求体的时间         |86ms                                     |
|writeResponseSpend    |写客户端响应体的时间           |0ms                                     |
|operations            |该请求涉及的关键内部操作耗时信息  |[*accessMeta=27ms, closeWriter=2ms, openWriter=4ms, postCreate=0ms, preCreate=0ms, writeData(16)=9ms] |
|extras                 |额外信息，用于辅助问题定位       |[fileId=626764d34000010096eb65b9] |

**Note**
>
> - 在关键内部操作耗时信息中，若某个操作的执行时间达到用户设置的阈值，会使用 * 标注，如：*accessMeta=27ms
>
> - 若某个操作执行了多次，会在括号中显示具体的执行次数，如：writeData(16)=9ms 表示 writeData 执行了16次

## 异步任务慢操作 ##

异步任务慢操作是指异步任务在迁移清理文件时，内部操作的执行时间达到用户设置的阈值时，会在日志文件中打印慢操作告警信息。

### 存储与配置 ###

**存储**

异步任务慢操作日志配置方式与上文中存储配置描述的一致，不同的是异步任务慢操作日志只支持输出到日志文件中，不支持输出到链路追踪系统的链路信息中。

**配置**

异步任务慢操作配置方式与上文中慢操作配置描述的一致，不同的是异步任务慢操作只支持内部操作的慢操作配置，请求相关的慢操作配置是无效的，有效的配置项为：

- scm.slowlog.enabled
- scm.slowlog.allOperation
- scm.slowlog.operation.xxx

**告警信息**

具体告警日志包含的信息如下：

| 审计信息       | 说明               | 示例                                                                     |
|------------|------------------|------------------------------------------------------------------------|
| taskId     | 异步任务的任务id        | 6465eb2c400065006447d0dc                                               |
| spend      | 本次任务总的处理时间       | 135ms                                                                  |
| fileId     | 处理的文件id          | 6465ea574000010087a9f371                                               |
| start      | 任务开始时间           | 2022-04-26 11:19:47.108                                                |
| end        | 任务结束时间           | 2022-04-26 11:19:47.243                                                |
| operations | 该任务涉及的关键内部操作耗时信息 | [*accessMeta=27ms, closeWriter=2ms, openWriter=4ms, writeData(16)=9ms] |
| extras     | 额外信息，用于辅助问题定位    | [readLobId=6465ea574000010087a9f371]                                   |

**Note**
>
> - 在关键内部操作耗时信息中，若某个操作的执行时间达到用户设置的阈值，会使用 * 标注，如：*accessMeta=27ms
>
> - 若某个操作执行了多次，会在括号中显示具体的执行次数，如：writeData(16)=9ms 表示 writeData 执行了16次


[config_means]:Maintainance/Node_Config/config_means.md
